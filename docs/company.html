<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>個股情緒時序</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js">async function drawCloudAndSource(){
  try{
    const data = await fetch("./data/news_compact.json").then(r=>r.json());
    const now = new Date();
    const items = data.filter(x=> (x.codes||[]).includes(code) && (now - new Date(x.ts) <= 7*24*3600*1000));
    const kw = {};
    const src = {};
    items.forEach(n=>{
      const url = new URL(n.link||"", location.href);
      const host = url.host || "unknown";
      src[host] = (src[host]||0) + 1;
      (n.detail||[]).forEach(d=>{
        const w = d.word || ""; if(!w) return;
        kw[w] = (kw[w]||0) + 1;
      });
    });
    const list = Object.entries(kw).map(([text, weight])=>[text, weight]).sort((a,b)=>b[1]-a[1]).slice(0,80);
    WordCloud(document.getElementById("wcanvas"), { list, gridSize: 8, weightFactor: 4, backgroundColor: "white" });

    const labels = Object.keys(src); const vals = labels.map(k=>src[k]);
    new Chart(document.getElementById("sourceChart"), {type:"pie", data:{labels, datasets:[{data: vals}]}});
  }catch(e){}
}
drawCloudAndSource();
async function loadWeekly(){try{const csv=await fetch("./data/company_scores.csv").then(r=>r.text());const rows=Papa.parse(csv,{header:true}).data.filter(r=>r.code===code);const now=new Date();let sum7=0, cnt=0;rows.forEach(r=>{const d=new Date(r.date);if(now-d<=7*24*3600*1000){sum7+=+r.score_w||0;cnt++;}});const avg=(cnt?sum7/cnt:0);const arrow= avg>0? "▲": (avg<0? "▼":"→");document.getElementById("weeklySent").textContent=`本週情緒指標：${avg.toFixed(2)} ${arrow}`;}catch(e){} } loadWeekly();
async function loadSrcWeights(){try{const sw=await fetch("./data/source_weights.json").then(r=>r.json());const keys=Object.keys(sw).sort((a,b)=>sw[b]-sw[a]).slice(0,8);document.getElementById("srcWeights").textContent=keys.map(k=>`${k}:${sw[k].toFixed(2)}`).join(" · ");}catch(e){} } loadSrcWeights();
</script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js">async function drawCloudAndSource(){
  try{
    const data = await fetch("./data/news_compact.json").then(r=>r.json());
    const now = new Date();
    const items = data.filter(x=> (x.codes||[]).includes(code) && (now - new Date(x.ts) <= 7*24*3600*1000));
    const kw = {};
    const src = {};
    items.forEach(n=>{
      const url = new URL(n.link||"", location.href);
      const host = url.host || "unknown";
      src[host] = (src[host]||0) + 1;
      (n.detail||[]).forEach(d=>{
        const w = d.word || ""; if(!w) return;
        kw[w] = (kw[w]||0) + 1;
      });
    });
    const list = Object.entries(kw).map(([text, weight])=>[text, weight]).sort((a,b)=>b[1]-a[1]).slice(0,80);
    WordCloud(document.getElementById("wcanvas"), { list, gridSize: 8, weightFactor: 4, backgroundColor: "white" });

    const labels = Object.keys(src); const vals = labels.map(k=>src[k]);
    new Chart(document.getElementById("sourceChart"), {type:"pie", data:{labels, datasets:[{data: vals}]}});
  }catch(e){}
}
drawCloudAndSource();
async function loadWeekly(){try{const csv=await fetch("./data/company_scores.csv").then(r=>r.text());const rows=Papa.parse(csv,{header:true}).data.filter(r=>r.code===code);const now=new Date();let sum7=0, cnt=0;rows.forEach(r=>{const d=new Date(r.date);if(now-d<=7*24*3600*1000){sum7+=+r.score_w||0;cnt++;}});const avg=(cnt?sum7/cnt:0);const arrow= avg>0? "▲": (avg<0? "▼":"→");document.getElementById("weeklySent").textContent=`本週情緒指標：${avg.toFixed(2)} ${arrow}`;}catch(e){} } loadWeekly();
async function loadSrcWeights(){try{const sw=await fetch("./data/source_weights.json").then(r=>r.json());const keys=Object.keys(sw).sort((a,b)=>sw[b]-sw[a]).slice(0,8);document.getElementById("srcWeights").textContent=keys.map(k=>`${k}:${sw[k].toFixed(2)}`).join(" · ");}catch(e){} } loadSrcWeights();
</script>
<style>.muted{opacity:.7}</style>
<script src="https://cdn.jsdelivr.net/npm/wordcloud2.js@1.2.2/src/wordcloud2.min.js">async function drawCloudAndSource(){
  try{
    const data = await fetch("./data/news_compact.json").then(r=>r.json());
    const now = new Date();
    const items = data.filter(x=> (x.codes||[]).includes(code) && (now - new Date(x.ts) <= 7*24*3600*1000));
    const kw = {};
    const src = {};
    items.forEach(n=>{
      const url = new URL(n.link||"", location.href);
      const host = url.host || "unknown";
      src[host] = (src[host]||0) + 1;
      (n.detail||[]).forEach(d=>{
        const w = d.word || ""; if(!w) return;
        kw[w] = (kw[w]||0) + 1;
      });
    });
    const list = Object.entries(kw).map(([text, weight])=>[text, weight]).sort((a,b)=>b[1]-a[1]).slice(0,80);
    WordCloud(document.getElementById("wcanvas"), { list, gridSize: 8, weightFactor: 4, backgroundColor: "white" });

    const labels = Object.keys(src); const vals = labels.map(k=>src[k]);
    new Chart(document.getElementById("sourceChart"), {type:"pie", data:{labels, datasets:[{data: vals}]}});
  }catch(e){}
}
drawCloudAndSource();
async function loadWeekly(){try{const csv=await fetch("./data/company_scores.csv").then(r=>r.text());const rows=Papa.parse(csv,{header:true}).data.filter(r=>r.code===code);const now=new Date();let sum7=0, cnt=0;rows.forEach(r=>{const d=new Date(r.date);if(now-d<=7*24*3600*1000){sum7+=+r.score_w||0;cnt++;}});const avg=(cnt?sum7/cnt:0);const arrow= avg>0? "▲": (avg<0? "▼":"→");document.getElementById("weeklySent").textContent=`本週情緒指標：${avg.toFixed(2)} ${arrow}`;}catch(e){} } loadWeekly();
async function loadSrcWeights(){try{const sw=await fetch("./data/source_weights.json").then(r=>r.json());const keys=Object.keys(sw).sort((a,b)=>sw[b]-sw[a]).slice(0,8);document.getElementById("srcWeights").textContent=keys.map(k=>`${k}:${sw[k].toFixed(2)}`).join(" · ");}catch(e){} } loadSrcWeights();
</script>
</head><body><main class="container">
<h1 id="title">個股情緒時序</h1><p id="weeklySent" class="muted"></p><p><small>來源可信度權重（Top 8）：</small><span id="srcWeights"></span></p>
<p><a href="./">← 返回首頁</a></p>
<canvas id="cchart"></canvas>

<section>
  <h3>近期相關新聞</h3>
  <div id="newslist"></div>
  <div class="grid"><article><h3>近 7 日關鍵詞雲</h3><canvas id="wcanvas" width="500" height="350"></canvas></article><article><h3>新聞來源分布</h3><canvas id="sourceChart"></canvas></article></div>
</section>

<section class="grid">
  <article>
    <h3>近 7 日關鍵詞雲</h3>
    <div id="cloud"></div>
  </article>
  <article>
    <h3>近期來源分布</h3>
    <canvas id="srcPie"></canvas>
  </article>
</section>

<section>
  <h3>單文檔影響力 Top 10（近 7 日）</h3>
  <div id="contribTop"></div>
</section>
<section>
  <h3>來源可信度 × 影響力（近 7 日）</h3>
  <canvas id="srcImpact"></canvas>
</section>
</main>
<script>
async function contribDecompose(){
  try{
    const data = await fetch("./data/news_compact.json").then(r=>r.json());
    const sw = await fetch("./data/source_weights.json").then(r=>r.json()).catch(()=>({}));
    const now = new Date(); const ms7 = 7*24*3600*1000;
    const items = data.filter(x=> (x.codes||[]).includes(code) && (now - new Date(x.ts) <= ms7));
    // per-article contribution: use article score * source weight as proxy
    const rows = items.map(n=>{
      const host = (new URL(n.link||"", location.href)).host || "unknown";
      const w = sw[host] || 1.0;
      const contrib = (n.score||0) * w;
      return {ts:n.ts, title:n.title, link:n.link, host, w, contrib};
    }).sort((a,b)=>Math.abs(b.contrib)-Math.abs(a.contrib)).slice(0,10);
    let html = "<ol>";
    for(const r of rows){
      html += `<li><a href="${r.link}" target="_blank">${r.title}</a> <small>[${r.host} × ${r.w.toFixed(2)}] 貢獻=${r.contrib.toFixed(2)}</small></li>`;
    }
    html += "</ol>";
    document.getElementById("contribTop").innerHTML = html;
    // aggregate by host
    const agg = {};
    items.forEach(n=>{
      const host = (new URL(n.link||"", location.href)).host || "unknown";
      const w = sw[host] || 1.0;
      agg[host] = (agg[host]||0) + (n.score||0)*w;
    });
    const labels = Object.keys(agg).slice(0,12);
    const vals = labels.map(k=>agg[k]);
    new Chart(document.getElementById("srcImpact"), {type:"bar", data:{labels, datasets:[{label:"可信度×影響力", data: vals}]}, options:{indexAxis:'y'}});
  }catch(e){}
}
contribDecompose();
</script>

<script>
const params = new URLSearchParams(location.search);
const code = params.get("code") || "";
document.getElementById("title").textContent = `個股 ${code} 情緒時序`;

async function loadSeries(){
  try{
    const csv = await fetch("./data/company_scores.csv").then(r=>r.text());
    const rows = Papa.parse(csv, {header:true}).data.filter(r=>r.code===code);
    const labels = rows.map(r=>r.date);
    const vals = rows.map(r=>+r.score_w);
    new Chart(document.getElementById("cchart"), {
      type:"line", data:{labels, datasets:[{label:code, data: vals}]},
      options:{interaction:{mode:'index'}, scales:{y:{beginAtZero:false}}}
    });
  }catch(e){}
}

async function loadNews(){
  try{
    const data = await fetch("./data/news_compact.json").then(r=>r.json());
    const items = data.filter(x=> (x.codes||[]).includes(code)).slice(0,50);
    let html = "<ul>";
    for(const n of items){
      const hits = (n.detail||[]).filter(d=> (d.codes||[]).includes(code)).slice(0,5).map(d=>`${d.word}${d.eff_label?`(${d.eff_label})`:""}`).join("、");
      html += `<li><span class="muted">${n.ts}</span> <a href="${n.link}" target="_blank">${n.title}</a>  <small>分數 ${n.score.toFixed(2)} ；命中：${hits}</small></li>`;
    }
    html += "</ul>";
    document.getElementById("newslist").innerHTML = html;
  }catch(e){}
}

async function enrich(){
  try{
    const data = await fetch("./data/news_compact.json").then(r=>r.json());
    const cutoff = new Date(Date.now()-7*24*3600*1000);
    const items = data.filter(x=> (x.codes||[]).includes(code) && new Date(x.ts) >= cutoff);
    // tag cloud
    const freq = {};
    for(const n of items){
      for(const d of (n.detail||[])){
        if((d.codes||[]).includes(code)){
          const key = d.word + (d.eff_label?`(${d.eff_label})`:"");
          freq[key] = (freq[key]||0)+1;
        }
      }
    }
    const entries = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,40);
    let html = ""; const maxv = entries.length? entries[0][1]:1;
    for(const [w,c] of entries){
      const sz = 12 + Math.round(20 * c / maxv);
      html += `<span style="font-size:${sz}px;margin:.25rem;display:inline-block">${w}</span>`;
    }
    document.getElementById("cloud").innerHTML = html;
    // source distribution
    const host = (u)=>{ try{ return new URL(u).host; }catch(e){ return ""; } };
    const hist = {}; for(const n of items){ const h = host(n.link); hist[h]=(hist[h]||0)+1; }
    const labels = Object.keys(hist).slice(0,10);
    const vals = labels.map(k=>hist[k]);
    new Chart(document.getElementById("srcPie"), {type:"pie", data:{labels, datasets:[{data:vals}]}});
  }catch(e){}
}

loadSeries(); loadNews(); enrich();
async function drawCloudAndSource(){
  try{
    const data = await fetch("./data/news_compact.json").then(r=>r.json());
    const now = new Date();
    const items = data.filter(x=> (x.codes||[]).includes(code) && (now - new Date(x.ts) <= 7*24*3600*1000));
    const kw = {};
    const src = {};
    items.forEach(n=>{
      const url = new URL(n.link||"", location.href);
      const host = url.host || "unknown";
      src[host] = (src[host]||0) + 1;
      (n.detail||[]).forEach(d=>{
        const w = d.word || ""; if(!w) return;
        kw[w] = (kw[w]||0) + 1;
      });
    });
    const list = Object.entries(kw).map(([text, weight])=>[text, weight]).sort((a,b)=>b[1]-a[1]).slice(0,80);
    WordCloud(document.getElementById("wcanvas"), { list, gridSize: 8, weightFactor: 4, backgroundColor: "white" });

    const labels = Object.keys(src); const vals = labels.map(k=>src[k]);
    new Chart(document.getElementById("sourceChart"), {type:"pie", data:{labels, datasets:[{data: vals}]}});
  }catch(e){}
}
drawCloudAndSource();
async function loadWeekly(){try{const csv=await fetch("./data/company_scores.csv").then(r=>r.text());const rows=Papa.parse(csv,{header:true}).data.filter(r=>r.code===code);const now=new Date();let sum7=0, cnt=0;rows.forEach(r=>{const d=new Date(r.date);if(now-d<=7*24*3600*1000){sum7+=+r.score_w||0;cnt++;}});const avg=(cnt?sum7/cnt:0);const arrow= avg>0? "▲": (avg<0? "▼":"→");document.getElementById("weeklySent").textContent=`本週情緒指標：${avg.toFixed(2)} ${arrow}`;}catch(e){} } loadWeekly();
async function loadSrcWeights(){try{const sw=await fetch("./data/source_weights.json").then(r=>r.json());const keys=Object.keys(sw).sort((a,b)=>sw[b]-sw[a]).slice(0,8);document.getElementById("srcWeights").textContent=keys.map(k=>`${k}:${sw[k].toFixed(2)}`).join(" · ");}catch(e){} } loadSrcWeights();
</script>
</body></html>
