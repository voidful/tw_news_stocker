<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>穩健性矩陣熱力圖</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
<style>.grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}</style>
</head><body><main class="container">
<h1>穩健性矩陣熱力圖</h1>
<p><a href="./">← 返回首頁</a></p>
<div class="grid">
  <article>
    <label>指標
      <select id="metric">
        <option value="sharpe">Sharpe</option>
        <option value="total_ret">累積報酬</option>
        <option value="maxdd">最大回撤</option>
      </select>
    </label>
    <label>X 軸
      <select id="xaxis">
        <option value="half_life">half_life</option>
        <option value="topN">topN</option>
        <option value="min_score">min_score</option>
        <option value="vol_target">vol_target</option>
        <option value="rebalance_freq">rebalance_freq</option>
        <option value="kelly_coef">kelly_coef</option>
      </select>
    </label>
    <label>Y 軸
      <select id="yaxis">
        <option value="topN">topN</option>
        <option value="min_score">min_score</option>
        <option value="vol_target">vol_target</option>
        <option value="rebalance_freq">rebalance_freq</option>
        <option value="kelly_coef">kelly_coef</option>
        <option value="half_life">half_life</option>
      </select>
    </label>
    <label>風控模型
      <select id="risk_model">
        <option value="equal">equal</option>
        <option value="invvol" selected>invvol</option>
        <option value="kelly">kelly</option>
      </select>
    </label>
  </article>
  <article>
    <canvas id="heat"></canvas>
  </article>
</div>
<article>
  <h3>穩健性摘要</h3>
  <pre id="summary" class="code"></pre>
</article>
<article><h3>Top Robust 組合</h3><div id="robustTable"></div></article>
<article><h3>穩健性雷達圖（Top 組合）</h3><canvas id="radar"></canvas></article>
<script>
let raw = [];
async function loadCSV(){
  const csv = await fetch("./data/sensitivity_grid.csv").then(r=>r.text());
  raw = Papa.parse(csv, {header:true, dynamicTyping:true}).data;
}
function uniq(a){return [...new Set(a)];}
function toHeat(metric, xa, ya, filter){
  const rows = raw.filter(r => (!filter.risk_model || r.risk_model===filter.risk_model));
  const xs = uniq(rows.map(r=>r[xa])).sort((a,b)=>a-b);
  const ys = uniq(rows.map(r=>r[ya])).sort((a,b)=>a-b);
  const data = [];
  for (let i=0;i<xs.length;i++){
    for (let j=0;j<ys.length;j++){
      const cell = rows.filter(r=>r[xa]===xs[i] && r[ya]===ys[j]);
      if(cell.length){
        const m = cell.reduce((s,r)=>s + (+r[metric]||0),0)/cell.length;
        data.push({x:i, y:j, v:m});
      }
    }
  }
  return {xs, ys, data};
}
let chart;
function render(){
  const metric = document.getElementById("metric").value;
  const xa = document.getElementById("xaxis").value;
  const ya = document.getElementById("yaxis").value;
  const risk_model = document.getElementById("risk_model").value;
  const {xs, ys, data} = toHeat(metric, xa, ya, {risk_model});
  const maxv = Math.max(...data.map(d=>d.v)), minv = Math.min(...data.map(d=>d.v));
  const ds = data.map(d=>({x:d.x, y:d.y, v:d.v, width:20, height:20}));
  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("heat"), {
    type: 'matrix',
    data: { datasets: [{ label: metric, data: ds, backgroundColor: ctx => {
      const v = ctx.raw.v; const t = (v-minv)/(maxv-minv+1e-9);
      const r = Math.floor(255*(1-t)), g = Math.floor(255*t);
      return `rgba(${r},${g},100,0.8)`;
    }}]},
    options: { scales: {x:{ticks:{callback:(v)=>xs[v]}}, y:{ticks:{callback:(v)=>ys[v]}}}, plugins:{legend:{display:false}} }
  });
}
async function loadSummary(){
  try{
    const t = await fetch("./data/robustness_summary.md").then(r=>r.text());
    document.getElementById("summary").textContent = t;
  }catch(e){}
}
document.getElementById("metric").onchange = render;
document.getElementById("xaxis").onchange = render;
document.getElementById("yaxis").onchange = render;
document.getElementById("risk_model").onchange = render;
loadCSV().then(render);
loadSummary();
async function loadRadar(){try{const csv=await fetch("./data/sensitivity_radar_top.csv").then(r=>r.text());const rows=Papa.parse(csv,{header:true,dynamicTyping:true}).data; if(!rows.length) return; const top=rows[0]; const labels=["Sharpe","Total","-MaxDD"]; const data=[top.norm_sharpe, top.norm_total, top.norm_maxdd]; new Chart(document.getElementById("radar"), {type:"radar",data:{labels, datasets:[{label:`HL=${top.half_life},N=${top.topN},m=${top.min_score},${top.risk_model}`, data}]}, options:{scales:{r:{min:0,max:1}}}});}catch(e){}} loadRadar();
async function loadRank(){try{const csv=await fetch("./data/sensitivity_rank.csv").then(r=>r.text());const rows=Papa.parse(csv,{header:true,dynamicTyping:true}).data.slice(0,20);let html="<table><thead><tr>";const cols=["avg_rank","half_life","topN","min_score","risk_model","vol_target","rebalance_freq","kelly_coef","sharpe","total_ret","maxdd"];html+=cols.map(c=>`<th>${c}</th>`).join("")+"</tr></thead><tbody>";for(const r of rows){html+=`<tr>${cols.map(c=>`<td>${(r[c]??"")}</td>`).join("")}</tr>`;}html+="</tbody></table>";document.getElementById("robustTable").innerHTML=html;}catch(e){}};loadRank();
</script>
</main></body></html>
