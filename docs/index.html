<!doctype html><html lang="zh-Hant">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>簡化版｜情緒 × 股票 消息面</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.badge{padding:0.15rem 0.4rem;border-radius:0.4rem;font-variant-numeric:tabular-nums}
.pos{background:#e6ffea;color:#0a7f2e}
.neg{background:#ffeaea;color:#a11010}
.mono{font-variant-numeric:tabular-nums}
.list{max-height:60vh;overflow:auto}
small.host{color:#667}
code.tag{background:#f2f2f2;color:#333;padding:0 .35rem;border-radius:.3rem}
.details{margin:.25rem 0 .75rem .25rem;border-left:3px solid #eee;padding-left:.5rem}
.ctrl {display:flex;flex-wrap:wrap;gap:.5rem;align-items:end}
.ctrl label{margin-right:.5rem}
button.linklike{background:none;border:none;color:#1a73e8;cursor:pointer;padding:0}
</style>
</head>
<body>
<main class="container">

  <h2>市場情緒快照</h2>

  <!-- 控制列 -->
  <div class="ctrl">
    <label>期間
      <select id="range">
        <option value="1">24小時</option>
        <option value="3">3天</option>
        <option value="7" selected>7天</option>
        <option value="30">30天</option>
      </select>
    </label>

    <label>來源頻數篩選
      <select id="srcFreq">
        <option value="all" selected>全部</option>
        <option value="top5">Top 5 來源</option>
        <option value="top10">Top 10 來源</option>
      </select>
    </label>

    <label>可信度權重
      <select id="trustMask">
        <option value="off" selected>關閉</option>
        <option value="pos">只套正向</option>
        <option value="neg">只套負向</option>
        <option value="both">正負皆套</option>
      </select>
    </label>

    <label>每檔展開
      <input id="perStockN" type="number" value="5" min="1" max="50" style="width:5rem"> 則新聞
    </label>

    <label><input id="wlOnly" type="checkbox"> 只看觀察名單</label>

    <input id="q" type="search" placeholder="搜尋代號或標題關鍵字…" style="flex:1 1 240px">

    <button id="btnExport" class="secondary">匯出 CSV</button>
  </div>

  <p class="mono"><span id="asof"></span></p>

  <div class="grid">
    <article>
      <h4>Top 正向（前 15）</h4>
      <ol id="toppos" class="list"></ol>
    </article>
    <article>
      <h4>Top 負向（前 15）</h4>
      <ol id="topneg" class="list"></ol>
    </article>
  </div>

  <h3>最新新聞（符合條件的全部）</h3>
  <div id="news" class="list"></div>
</main>

<script>
const LS_KEY_WL = "twnews_watchlist";

function getWatchlist(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY_WL) || "[]"); }catch(e){ return []; }
}
function setWatchlist(arr){
  localStorage.setItem(LS_KEY_WL, JSON.stringify(Array.from(new Set(arr))));
}
function addSparkline(el, series){
  const c = document.createElement("canvas");
  c.width = 120; c.height = 28; c.style.marginLeft = "8px";
  el.appendChild(c);
  const xs = series.map(r=>r.date);
  const ys = series.map(r=>r.score);
  new Chart(c.getContext("2d"), {
    type: "line",
    data: { labels: xs, datasets: [{ data: ys, pointRadius: 0, tension: 0.3 }]},
    options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, elements:{line:{borderWidth:1}}}
  });
}
</script>

<script>
async function main(){
  const daysSel   = document.getElementById("range");
  const srcFreqEl = document.getElementById("srcFreq");
  const trustEl   = document.getElementById("trustMask");
  const perStockN = document.getElementById("perStockN");
  const wlOnly    = document.getElementById("wlOnly");
  const qEl       = document.getElementById("q");
  const btnExport = document.getElementById("btnExport");

  const news  = await fetch("./data/news_compact.json").then(r=>r.json()).catch(()=>[]);
  const daily = await fetch("./data/daily_sentiment.json").then(r=>r.json()).catch(()=>[]);
  const sw    = await fetch("./data/source_weights.json").then(r=>r.json()).catch(()=>({}));

  if(!Array.isArray(news)) return;

  const wl = new Set(getWatchlist());

  // 來源頻數 Top-K
  function topHosts(k){
    const cnt = {};
    news.forEach(n=>{
      const h = n.source_host || (n.link ? new URL(n.link).host : "");
      cnt[h] = (cnt[h]||0)+1;
    });
    return Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,k).map(x=>x[0]);
  }

  // 取得來源可信度權重（支援 {host: number} 或 {host: {pos,neg}}）
  function weightForHost(host, val){
    const w = sw[host];
    if(w == null) return 1.0;
    if (typeof w === "number") return w;
    const sgn = (val>=0) ? "pos" : "neg";
    return (w[sgn] != null) ? Number(w[sgn]) : 1.0;
  }

  function filterNews(){
    const days = +daysSel.value;
    const now = new Date();
    const mask = srcFreqEl.value;
    const allowHosts = mask==="all" ? null : new Set(topHosts(mask==="top5"?5:10));
    const q = (qEl.value||"").trim().toLowerCase();

    return news.filter(x=>{
      if(now - new Date(x.ts) > days*24*3600*1000) return false;
      const host = x.source_host || (x.link ? new URL(x.link).host : "");
      if(allowHosts && !allowHosts.has(host)) return false;
      if(wlOnly.checked){
        const has = (x.codes||[]).some(c=>wl.has(c));
        if(!has) return false;
      }
      if(!q) return true;
      const inCodes = (x.codes||[]).some(c=>c.toLowerCase().includes(q));
      const inTitle = (x.title||"").toLowerCase().includes(q);
      return inCodes || inTitle;
    });
  }

  function seriesFor(code, days){
    const end = new Date();
    const arr = [];
    for(let i=days-1;i>=0;--i){
      const d = new Date(end - i*24*3600*1000);
      const ds = d.toISOString().slice(0,10);
      arr.push({date: ds, score: 0});
    }
    const sub = daily.filter(r=>r.code===code);
    const idx = new Map(arr.map((r,i)=>[r.date,i]));
    sub.forEach(r=>{ if(idx.has(r.date)) arr[idx.get(r.date)].score += +r.score||0; });
    return arr;
  }

  // 加權聚合：依據 trustMask（off/pos/neg/both）套用來源可信度
  function aggByCode(items){
    const mode = trustEl.value; // off / pos / neg / both
    const m = {};
    items.forEach(n=>{
      const host = n.source_host || (n.link ? new URL(n.link).host : "");
      let s = +n.sent_score || 0;
      if(mode !== "off" && s !== 0){
        const applyPos = (mode==="pos" || mode==="both") && s>0;
        const applyNeg = (mode==="neg" || mode==="both") && s<0;
        if(applyPos || applyNeg){
          s = s * weightForHost(host, s);
        }
      }
      (n.codes||[]).forEach(c=>{
        m[c] = (m[c]||0) + s;
      });
    });
    return Object.entries(m).map(([code,score])=>({code,score}));
  }

  function recentNewsFor(code, items, k){
    return items
      .filter(n => (n.codes||[]).includes(code))
      .sort((a,b)=> new Date(b.ts)-new Date(a.ts))
      .slice(0, k);
  }

  function render(){
    const items = filterNews();
    const rows  = aggByCode(items);
    const days  = +daysSel.value;
    const kList = Math.max(1, Math.min(50, +perStockN.value||5));

    // 只看觀察名單時，rows 也過濾
    const rows2 = wlOnly.checked ? rows.filter(r=>wl.has(r.code)) : rows;

    const topp = rows2.filter(r=>r.score>=0).sort((a,b)=>b.score-a.score).slice(0,15);
    const topn = rows2.filter(r=>r.score<0).sort((a,b)=>a.score-b.score).slice(0,15);

    document.getElementById("asof").textContent =
      `符合條件新聞 ${items.length} 則，股票數 ${rows2.length}` + (wlOnly.checked? "（觀察名單）":"");

    const fmt = v => (v>=0?`+${v.toFixed(2)}`:v.toFixed(2));
    const toppEl = document.getElementById("toppos"); toppEl.innerHTML="";
    const topnEl = document.getElementById("topneg"); topnEl.innerHTML="";

    function mkRow(target, r){
      const li = document.createElement("li");
      const watch = document.createElement("button");
      watch.className = "secondary";
      watch.style.marginLeft = "8px";
      const isOn = wl.has(r.code);
      watch.textContent = isOn ? "★ 取消追蹤" : "☆ 追蹤";
      watch.onclick = ()=>{
        if(wl.has(r.code)) wl.delete(r.code); else wl.add(r.code);
        setWatchlist(Array.from(wl)); render();
      };

      // 展開/收合近 N 則新聞
      const btnToggle = document.createElement("button");
      btnToggle.className = "linklike";
      btnToggle.textContent = `展開近 ${kList} 則`;
      const detailWrap = document.createElement("div");
      detailWrap.className = "details";
      detailWrap.style.display = "none";

      btnToggle.onclick = ()=>{
        if(detailWrap.style.display === "none"){
          detailWrap.style.display = "block";
          btnToggle.textContent = "收合";
          const list = recentNewsFor(r.code, items, kList);
          detailWrap.innerHTML = list.map(n=>{
            const s = +n.sent_score||0;
            const badge = `<span class="badge ${s>=0?"pos":"neg"}">${fmt(s)}</span>`;
            const host = n.source_host || (n.link ? new URL(n.link).host : "");
            return `<div><small class="host">${n.ts} · ${host}</small><br>
              ${badge} <a href="${n.link||"#"}" target="_blank">${n.title||"(無標題)"}</a></div>`;
          }).join("");
        }else{
          detailWrap.style.display = "none";
          btnToggle.textContent = `展開近 ${kList} 則`;
        }
      };

      li.innerHTML = `<span class="badge ${r.score>=0?"pos":"neg"}">${fmt(r.score)}</span> <code class="tag">${r.code}</code>`;
      li.appendChild(watch);
      li.appendChild(btnToggle);
      addSparkline(li, seriesFor(r.code, Math.max(7, days)));
      li.appendChild(detailWrap);
      target.appendChild(li);
    }

    topp.forEach(r=>mkRow(toppEl, r));
    topn.forEach(r=>mkRow(topnEl, r));

    // 最新新聞（時間倒序）
    const newsEl = document.getElementById("news");
    newsEl.innerHTML="";
    const sorted = [...items].sort((a,b)=> new Date(b.ts)-new Date(a.ts));
    sorted.slice(0,300).forEach(n=>{
      const s = +n.sent_score||0;
      const badge = `<span class="badge ${s>=0?"pos":"neg"}">${fmt(s)}</span>`;
      const codes = (n.codes||[]).map(c=>`<code class="tag">${c}</code>`).join(" ");
      const host = n.source_host || (n.link ? new URL(n.link).host : "");
      const div = document.createElement("article");
      div.innerHTML = `
        <h5 style="margin-bottom:.3rem;"><a href="${n.link||"#"}" target="_blank">${n.title||"(無標題)"}</a></h5>
        <small class="host">${n.ts} · ${host}</small><br/>
        ${badge} ${codes}
      `;
      newsEl.appendChild(div);
    });
  }

  // 事件
  [daysSel, srcFreqEl, trustEl, wlOnly].forEach(el=> el.onchange = render);
  perStockN.oninput = render;
  qEl.oninput = ()=>{ clearTimeout(window._t); window._t=setTimeout(render, 200); };
  btnExport.onclick = ()=>{
    const items = filterNews();
    const rows = items.flatMap(n=>{
      const s = +n.sent_score||0;
      return (n.codes||[""]).map(c=>({
        ts:n.ts, code:c, score:s, title:n.title||"", link:n.link||"", host:n.source_host||""
      }));
    });
    const header = "ts,code,score,title,link,host\n";
    const body = rows.map(r=>[
      r.ts, r.code, r.score,
      `"${(r.title||"").replace(/"/g,'""')}"`,
      r.link, r.host
    ].join(",")).join("\n");
    const blob = new Blob([header+body], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "news_sentiment_export.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  render();
}
main();
</script>
</body>
</html>
